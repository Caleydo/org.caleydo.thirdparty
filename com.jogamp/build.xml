<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     06.08.2013 10:34:31                                                        

     project    
     description
                   
     Samuel Gratzl                                                                
     ====================================================================== -->
<project name="project" default="package">
	<description>
            description
    </description>
	
	<property name="data.dir" location="../target/jogamp-all-platforms" />
	<property name="org" value="${project.groupId}" />
	<property name="base" value="${project.artifactId}" />
	<property name="version" value="${project.version}" />
	<property name="includes" value="*${base}*" />
	<property name="includesjar" value="*${base}.jar" />
	<property name="srcincludes" value="${base}-java-src.zip" />
	<property name="excludepackages" value="" />


	<property name="target.dir" location="${project.build.directory}" />
	<mkdir dir="${target.dir}" />

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: generate          
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="generatefragment">
		<attribute name="os" />
		<attribute name="arch" />
		<attribute name="osfilter" />
		<attribute name="archfilter" />
		<sequential>
			<pathconvert property="${base}-@{os}-@{arch}.native" pathsep=",\">
				<fileset dir="${data.dir}/lib/@{os}-@{arch}" includes="${includes}" />
				<flattenmapper />
			</pathconvert>
			<jar destfile="${target.dir}/${org}.${base}-@{os}-@{arch}.jar">
				<manifest>
					<attribute name="Bundle-ManifestVersion" value="2" />
					<attribute name="Bundle-Name" value="${org}.${base}-@{os}-@{arch}" />
					<attribute name="Bundle-SymbolicName" value="${org}.${base}-@{os}-@{arch};singleton:=true" />
					<attribute name="Bundle-Version" value="${version}" />
					<attribute name="Fragment-Host" value="${org}.${base};bundle-version=&quot;${version}&quot;" />
					<attribute name="Bundle-RequiredExecutionEnvironment" value="JavaSE-1.7" />
					<attribute name="Eclipse-PlatformFilter" value="(&amp; (osgi.os=@{osfilter}) (osgi.arch=@{archfilter}))" />
					<attribute name="Bundle-NativeCode" value="${${base}-@{os}-@{arch}.native}" />
				</manifest>
				<mappedresources>
					<fileset dir="${data.dir}/lib/@{os}-@{arch}" includes="${includes}" />
					<flattenmapper />
				</mappedresources>
			</jar>
			<delete dir="${target.dir}/${org}.${base}-@{os}-@{arch}" />
	    	<attachartifact file="${target.dir}/${org}.${base}-@{os}-@{arch}.jar" classifier="@{osfilter}-@{arch}"/>
		</sequential>
	</macrodef>

	<!-- ================================= 
          target: default              
         ================================= -->
    <target name="package" description="description">
		<pathconvert property="jar.list" pathsep="," dirsep="/">
			<fileset dir="${data.dir}/jar" includes="${includesjar}" />
			<flattenmapper />
		</pathconvert>
		<delete dir="${target.dir}/tmp" />
		<unjar dest="${target.dir}/tmp">
			<fileset dir="${data.dir}/jar" includes="${includesjar}" excludes="${excludepackages}"/>
		</unjar>
		<pathconvert property="packages.list" pathsep="," dirsep=".">
			<dirset dir="${target.dir}/tmp" excludes="META-INF" />
			<chainedmapper>
				<packagemapper from="*" to="*" />
				<regexpmapper from=".*target.tmp.(.*)" to="\1" />
			</chainedmapper>
		</pathconvert>
    	<delete dir="${target.dir}/tmp" />
    	<delete dir="${target.dir}/package" />
    	<copy todir="${target.dir}/package" >
    		<fileset dir="${data.dir}/jar" includes="${includesjar}" />
			<flattenmapper />
    	</copy>
    	<mkdir dir="${target.dir}/package/META-INF" />
    	<manifest file="${target.dir}/package/META-INF/MANIFEST.MF">
    		<attribute name="Bundle-ManifestVersion" value="2" />
			<attribute name="Bundle-Name" value="${org}.${base}" />
			<attribute name="Bundle-SymbolicName" value="${org}.${base}" />
			<attribute name="Bundle-Version" value="${version}" />
			<attribute name="Bundle-RequiredExecutionEnvironment" value="JavaSE-1.7" />
			<attribute name="Bundle-ClassPath" value="${jar.list}" />
    		<attribute name="Require-Bundle" value="org.eclipse.swt;bundle-version=&quot;3.102.0&quot;resolution:=optional" /><!--for swt binding-->
			<attribute name="Export-Package" value="${packages.list}" />
    	</manifest>
		<!--<jar destfile="${target.dir}/${org}.${base}.jar">
			<manifest>
				<attribute name="Bundle-ManifestVersion" value="2" />
				<attribute name="Bundle-Name" value="${org}.${base}" />
				<attribute name="Bundle-SymbolicName" value="${org}.${base}" />
				<attribute name="Bundle-Version" value="${version}" />
				<attribute name="Bundle-RequiredExecutionEnvironment" value="JavaSE-1.7" />
				<attribute name="Bundle-ClassPath" value="${${base}.jar}" />
				<attribute name="Export-Package" value="${${base}.packages}" />
			</manifest>
			<mappedresources>
				<fileset dir="${data.dir}/jar" includes="${includesjar}" />
				<flattenmapper />
			</mappedresources>
		</jar>
    	<attachartifact file="${target.dir}/${org}.${base}.jar" type="jar"/>-->
		<!--<pathconvert property="test2" pathsep="," dirsep="." preserveduplicates="false">
			<files>
			<mappedresources>
				<fileset dir="target/test" excludes="META-INF/**" includes="**/*.class"/>
				<chainedmapper>
					<packagemapper from="*" to="*" />
					<regexpmapper from=".*/target/test/(.*)/.*.class" to="\1" handledirsep="yes" />
				</chainedmapper>
			</mappedresources>
				</files>
		</pathconvert>-->
		
		<zip destfile="${target.dir}/${org}.${base}-sources.jar">
			<zipfileset >
				<fileset dir="${data.dir}" includes="${srcincludes}" />
			</zipfileset>
		</zip>
		<echo> attaching artifact ${target.dir}/${org}.${base}-sources.jar </echo>
    	<attachartifact file="${target.dir}/${org}.${base}-sources.jar" classifier="sources"/>
    	
	
		<generatefragment os="linux" arch="amd64" osfilter="linux" archfilter="x86_64"  />
		<generatefragment os="linux" arch="i586" osfilter="linux" archfilter="x86" />
		<generatefragment os="macosx" arch="universal" osfilter="macosx" archfilter="x86_64" />
		<generatefragment os="windows" arch="amd64" osfilter="win32" archfilter="x86_64" />
		<generatefragment os="windows" arch="i586" osfilter="win32" archfilter="x86" />
    </target>
</project>
